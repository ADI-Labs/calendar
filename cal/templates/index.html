<!DOCTYPE html>
<head>
	<title>Columbia University Calendar</title>
	<link rel="stylesheet" type="text/css" href={{ url_for('static', filename='css/style.css') }}>
        <script src='{{ url_for("static", filename="js/react-0.12.2.js") }}'></script>
        <script src='{{ url_for("static", filename="js/JSXTransformer-0.12.2.js") }}'></script>
        <script src='{{ url_for("static", filename="js/jquery-1.10.0.min.js") }}'></script>
</head>

<body>
    <div id="content">
    </div>

    <script type="text/jsx">
        function formatTime(d) {
            return d.toTimeString().slice(0, 5);
        }
        var REvent = React.createClass({
            click: function() {
            }, 
            render: function() {
                var start = new Date(this.props.data.start);
                var width = 1;
                var timeString = formatTime(start);
                if (this.props.data.end !== null) {
                    var end = new Date(this.props.data.end);
                    // TODO handle end of month problems
                    width = end.getDate() - start.getDate() + 1;
                    timeString += " &ndash; " + formatTime(end);
                }

                return (
                    <div className="event" onclick={ this.click }>
                        { timeString }  <br/>
                        <a href={this.props.data.url}> { this.props.data.name } </a>
                    </div>
                );
            }
        })

        var RDay = React.createClass({
            render: function() {
                var events = this.props.eventList.map(function(evt, i) {
                    return <REvent data={ evt }/>
                });

                return (
                    <td className="day">
                        { events }
                    </td>
                );
            }
        })

        var RWeek = React.createClass({
            render: function() {
                var events = [[], [], [], [], [], [], []];
                for (var i = 0; i < this.props.eventList.length; i++) {
                    var evt = this.props.eventList[i];
                    var start = new Date(evt.start);
                    events[start.getDay()].push(evt);
                }

                var days = [];
                for (var i = 0; i < 7; i++) {
                    days.push(
                        <RDay eventList={ events[i] }/>
                    )
                }

                return (
                    <tr className="week">
                        { days }
                    </tr>
                );
            }
        })

        var RCalendar = React.createClass({
            render: function() {
                return (
                    <table className="calendar">
                        <thead>
                            <td> Sunday </td>
                            <td> Monday </td>
                            <td> Tuesday </td>
                            <td> Wednesday </td>
                            <td> Thursday </td>
                            <td> Friday </td>
                            <td> Saturday </td>
                        </thead>

                        <RWeek eventList={ this.props.eventList }/>
                    </table>
                );
            }
        })

        var RFiltering = React.createClass({
            remove: function(uid) {
                this.props.removeUser(uid)
            },

            render: function() {
                var users = [];
                for (var i = 0; i < this.props.userList.length; i++) {
                    var user = this.props.userList[i];

                    users.push(
                        <button onClick={ this.remove.bind(this, user.id) } name={ user.id }> Remove {user.name}</button>
                    );
                }

                return (
                    <div className="filtering"> 
                        { users }
                    </div>
                );
            }
        })

        var RSearch = React.createClass({
            render: function() {
                return (
                    <form className="search">
                        <input type="text"/>
                        <input type="submit" value="Search"/>
                    </form>
                );
            }
        })

        var RQuery = React.createClass({
            render: function() {
                return (
                    <div className="query">
                        <RSearch/>
                        <RFiltering userList={ this.props.userList } removeUser={this.props.removeUser}/>
                    </div>
                );
            }
        })

        var RApp = React.createClass({
            getInitialState: function() {
                return {eventList: [], userList: []};
            },
            componentDidMount: function() {
                $.getJSON('{{ url_for("events") }}', function(data) {
                    this.setState({eventList: data.data});
                }.bind(this));

                $.getJSON('{{ url_for("users") }}', function(data) {
                    this.setState({userList: data.data});
                }.bind(this));
            }, 

            removeUser: function(user_id) {
                this.setState({
                    eventList:  this.state.eventList.filter(function (evt) {
                                    return evt.user_id != user_id;
                                }),
                    userList:   this.state.userList.filter(function (user) {
                                    console.log(user.id);
                                    return user.id != user_id
                                })
                });
            },

            render: function() {
                return (
                    <div className="app">
                        <RCalendar eventList={ this.state.eventList } />
                        <RQuery eventList={this.state.eventList} userList={this.state.userList} removeUser={this.removeUser}/>
                    </div>
                );
            }
        })

        React.render(<RApp/>, document.getElementById("content"));
    </script>
</body>
